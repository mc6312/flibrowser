# Flibrowser
Ржавый крюк для ковыряния в оффлайновых библиотеках с индексом
в формате INPX и книгах, лежащих в зиповых архивах.


## ЧТО УМЕЕТ

Зохавывать MyHomeLib-совместимый индексный файл (.inpx), искать по нему
книжки, вытаскивать их из архивов библиотеки и, при необходимости, паковать
в отдельные зиповские архивы.

В данной версии заточено для работы с единственным индексным файлом.

Работает под Linux (в первую очередь), под Windows более-менее работает.
Работа под чем-то еще (MacOS X, экзотические *nix'ы и т.п.) теоретически
возможна, но не проверялась, и в обозримом будущем поддержка не планируется.


## КАК ЗАПУСКАТЬ

Установки не требует (кроме правки файла настроек руками или через морду).
При первом запуске (без файла настроек) вываливает окно первоначальной
настройки и создаёт файл настроек.
Запуск:
- под Linux - python3 flibrowser.pyz
- под Windows - pythonw flibrowser.pyz

Для упрощения отлова багов можно указать в командной строке опцию
--fake-library, в этом случае вместо реальной библиотеки (где может
быть мильён книг) будет загружена небольшая имитационная.


## ПОИСК КНИГ

1. В полях поиска можно (но не обязательно) использовать регулярные
   выражения. Нажатие на иконку в соответствующем поле проверяет
   правильность выражения.
2. В список найденных попадают книги, для которых совпали _все_
   непустые поля.

## ИЗВЛЕЧЕНИЕ КНИГ ИЗ АРХИВОВ БИБЛИОТЕКИ

Файлы извлекаются в указанный каталог, и, если это указано, пакуются
в ZIP.

Извлекаемые файлы книг именуются по шаблону (если он задан),
или используется оригинальное имя файла из библиотеки.

Шаблон - строка вида "текст %поле ...", где допустимы следующие поля:
```a - имя автора
  i - идентификатор книги (уникальный номер)
  f - оригинальное имя файла
  t - название книги
  n - номер в серии (если есть)
  s - название серии (если есть)
  r - (название серии[ - номер в серии]), если соотв. поля не пустые
```

Шаблон может содержать разделители путей, в этом случае создаются
подкаталоги.


## ЧТО ХОЧЕТ

Из ПО:
- Python 3.3 или новее.
- Модуль sqlparse для Python 3.x
- GTK+ 3.14 или новее.
- PythonGObject/PyGI

Под Linux всё вышеперечисленное устанавливается из репозиториев.

Под Windows всё сложнее:
1. С http://python.org берется установщик Python 3.4.x (т.к. на момент написания
   этого README версии 3.5 и новее не поддерживаются виндовым портом PyGObject)
2. PyGObject (с GTK 3.x в комплекте) ищется по ссылкам здесь:
   http://pygobject.readthedocs.io/en/latest/guide/faq.html
   где должен найтись установщик pygi-aio-3.*.exe версии 3.18 или новее.
   В нем при установке нужно указать установленную версию питона,
   выбрать в списках пакетов GTK 3.x и Pango.
   Остальное (вроде бы) не требуется.
3. Установить питоний модуль sqlparse командой:
   python -m pip install sqlparse

...после чего заглянуть опять в раздел "как запускать".

Из файлов:
0. Файл настроек (config). Очередность поиска:
   1. Каталог настроек (если он существует):
      - под Linux: ~/.config/flibrowser/
      - под Windows: %APPDATA%\flibrowser\
   2. Каталог, где расположен flibrowser.py
   С пустым файлом настроек или без оного программа запускается,
   вываливая сразу окно настроек.
   Файл genrelist.json ищется там же, где и файл настроек.
1. Индексный файл и архивы с книжками (расположение указывается в файле
   настроек).
2. Необязательный файл с соответствиями внутрибиблиотечных тэгов и их
   человекочитаемых названий (genrelist.json).
3. Необязательный файл templates с шаблонами имён файлов (см. "Извлечение
   книг из архивов библиотеки")


## ФАЙЛ НАСТРОЕК

config - текстовый файл, по одной записи вида "параметр значение" на строку.
Строки, начинающиеся с символа "#", считаются комментариями.

Параметры:
library_root_directory <путь> - корневой каталог с книгами и индексным
    файлом в формате inpx

library_index_file <путь> - имя индексного файла в формате .inpx
    если указано только имя файла без каталога, файл ищется в корневом
    каталоге библиотеки

extract_directory <путь> - каталог, куда разжимать книги
    должен быть указан абсолютный или относительный путь (в т.ч. относительно
    домашнего каталога пользователя)

data_directory <путь> - каталог с файлами нежелательных отбросов (см. далее)
    списком названий жанров и списком языков
    если не указано - файлы ищутся в том же каталоге, что и файл настроек

languages - список двухсимвольных кодов допустимых языков.
    Коды разделяются пробелами.
    Русский язык (ru) приколочен гвоздями внутри софтины навеки, ибо ваистену.


## ФАЙЛ СОСТОЯНИЯ МЕЖДУМОРДИЯ

uistate (расположение см. в п.1 раздела "Что хочет").
Хранит положение окна и состояние некоторых его элементов.
Для редактирования вручную не предназначен, создаётся и изменяется
программой автоматически.
Т.е. при необходимости (напр. при переносе программы на др. машину
или смене разрешения монитора) может быть безболезненно стёрт.


## ФОРМАТ СПИСКА ЖАНРОВ

genrelist.json - файл формата JSON, содержит словарь, где ключи - имена
тэгов, а значения - человекочитаемые названия тэгов:
{"tagname":"название тэга", ..., "othertag":"другой тэг"}
